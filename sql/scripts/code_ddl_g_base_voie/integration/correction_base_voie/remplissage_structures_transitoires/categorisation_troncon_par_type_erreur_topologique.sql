/*
Mise à jour du champ fid_etat permettant de répartir les tronçons par type d'erreur topologique
*/
-- Sélection des tronçons de voies différentes non-jointifs
SELECT
    a.cnumtrc || ',' AS code_troncon_a,
    c.ccomvoi AS id_voie_a,
    d.cnumtrc || ',' AS code_troncon_b,
    f.ccomvoi AS id_voie_a
FROM
    G_BASE_VOIE.TEMP_ILTATRC a
    INNER JOIN G_BASE_VOIE.TEMP_VOIECVT b ON b.cnumtrc = a.cnumtrc
    INNER JOIN G_BASE_VOIE.TEMP_VOIEVOI c ON c.ccomvoi = b.ccomvoi,
    G_BASE_VOIE.TEMP_ILTATRC d
    INNER JOIN G_BASE_VOIE.TEMP_VOIECVT e ON e.cnumtrc = d.cnumtrc
    INNER JOIN G_BASE_VOIE.TEMP_VOIEVOI f ON f.ccomvoi = e.ccomvoi
WHERE 
    a.cnumtrc < d.cnumtrc
    AND SDO_WITHIN_DISTANCE(
            d.ora_geometry, 
            a.ora_geometry, 
            'distance = 3'
        ) = 'TRUE'
    AND SDO_ANYINTERACT(a.ora_geometry, d.ora_geometry) <> 'TRUE'
    AND SDO_LRS.CONNECTED_GEOM_SEGMENTS(
            SDO_LRS.CONVERT_TO_LRS_GEOM(a.ora_geometry), 
            SDO_LRS.CONVERT_TO_LRS_GEOM(d.ora_geometry), 
            1
        ) = 'FALSE'
    AND b.ccomvoi <> e.ccomvoi
    AND a.cdvaltro = 'V'
    AND b.cvalide = 'V'
    AND c.cdvalvoi = 'V'
    AND d.cdvaltro = 'V'
    AND e.cvalide = 'V'
    AND f.cdvalvoi = 'V';
-- Résultat : 342 cas où des tronçons sont non-jointifs et appartenant à des voies différentes

-- Mise à jour du champ fid_etat de TEMP_B_TRONCON avec la valeur indiquant que le tronçon est mal connecté aux autres tronçons
--Le IN() de la condition se rempli avec le résultat de la requête ci-dessus (compilation des champs code_troncon_a et code_troncon_b en supprimant les doublons)
UPDATE TEMP_B_TRONCON 
SET fid_etat = 4
WHERE
    objectid IN(221, 253, 572, 863, 1142, 1151, 1305, 1355, 1708, 1758, 1938, 2708, 2077, 2080, 2129, 2083, 2180, 2762, 2748, 3649, 3872, 6965, 6284, 10484, 7298, 7051, 19802, 35437, 25506, 28071, 29553, 33395, 33458, 33564, 35659, 33590, 33884, 34130, 34131, 34133, 33788, 38886, 40479, 41650, 41664, 40861, 45178, 45179, 45181, 45183, 47492, 45358, 45520, 45204, 45401, 45246, 47448, 47531, 48989, 49063, 49673, 50171, 49185, 50112, 52175, 73520, 63051, 73237, 75244, 78807, 2524, 34159, 2645, 25456, 33584, 56748, 56816, 57014, 57015, 50987, 51201, 51227, 51432, 51439, 51440, 51447, 51501, 45316, 45445, 45669, 45677, 52667, 52673, 52674, 52675, 54481, 52564, 52567, 52684, 52686, 52687, 52707, 52583, 52604, 52610, 52612, 52620, 53750, 53756, 56887, 56975, 56847, 7504, 6589, 4383, 4385, 4577, 5269, 4592, 9174, 9175, 7813, 7818, 4307, 8110, 8139, 8733, 7308, 8626, 8068, 7149, 7875, 4525, 9220, 5882, 8601, 8603, 8605, 8607, 4175, 4558, 7138, 7836, 8789, 8805, 4556, 4371, 4427, 4711, 5802, 8483, 8785, 8874, 8602, 8604, 8880, 9146, 6434, 4284, 6602, 4328, 4329, 3304, 6599, 4545, 6090, 5097, 9186, 5360, 5363, 6565, 7856, 4288, 3324, 3325, 6402, 8606, 4503, 57258, 7987, 4546, 5270, 6569, 6116, 57539, 6598, 7876, 11785, 10815, 14032, 9609, 9590, 10002, 11842, 11770, 9607, 14031, 9892, 11677, 13997, 9610, 10147, 14756, 13019, 14742, 15528, 10240, 11019, 9805, 10369, 14758, 14770, 13883, 13938, 10900, 13916, 6127, 9410, 9412, 10960, 11028, 8624, 8666, 10905, 8929, 8964, 4431, 9931, 9112, 9373, 15883, 6610, 8809, 13490, 13491, 9597, 14034, 14060, 9113, 9137, 8677, 13068, 13492, 9815, 8906, 10163, 11590, 8914, 4570, 9606, 9899, 10057, 11221, 8859, 9585, 9384, 9385, 10164, 6410, 8753, 9086, 3082, 6566, 6593, 8612, 9374, 11783, 16214, 16906, 17868, 18376, 16290, 18550, 18557, 18553, 15527, 9895, 9589, 9601, 10814, 11964, 11861, 9594, 9595, 11679, 9533, 16867, 16340, 9596, 10059, 9591, 9592, 16715, 11913, 11912, 15480, 16561, 9894, 14751, 11721, 12301, 15395, 15840, 11832, 11965, 12816, 11809, 1068, 10894, 10884, 2098, 11808, 11192, 10897, 23562, 11725, 11193, 10895, 13884, 11950, 56587, 3956, 53749, 16221, 6314, 14015, 7302, 16217, 19896, 35660, 54667, 59359, 29849, 56859, 56922, 56862, 56860, 56855, 56856, 56857, 56858, 56845, 56846, 56841, 56842, 56843, 56844, 56852, 56854, 85846, 90422, 56338, 41843, 56619, 56906, 56907, 56917, 56918, 56916, 56908, 58213, 56905, 56941, 56919, 56924, 56923, 47533, 47567, 49067, 49077, 90862, 57231, 49239, 50533, 52212, 73522, 63067, 74369, 75255, 78921, 11807, 56861, 16116, 54477, 56863, 79844, 57304, 65051, 65095, 61551, 50989, 52709, 58553, 52712, 52711, 56925, 57272, 57288, 45682, 61100, 61925, 62975, 61895, 81516, 61047, 61876, 60826, 61342, 61908, 61269, 61059, 62171, 62233, 54812, 53751, 53759, 56892, 56891, 57326, 56851, 17231, 16493, 17029, 17030, 62367, 19620, 62603, 66776, 66854, 90052, 54102, 51890, 19547, 19693, 53997, 27936, 19652, 7162, 51820, 51549, 35506, 27861, 27859, 27966, 28194, 73385, 46609, 57322, 59214, 57264, 52608, 52597, 62152, 61475, 81397, 57826, 40466, 12579, 23477, 59983, 4285, 52596, 52595, 52593, 15765, 62730, 9581, 5098, 77030, 42056, 42432, 40696, 53974, 4292, 43579, 43580, 9580, 52570, 67798, 29255, 61851, 5274, 86016, 72200, 45243, 52020, 72742, 10823, 55357, 72342, 72166, 10003, 14471, 31065, 16322, 55364, 40454, 68571, 59379, 10158, 16893, 60855, 14743, 15537, 10242, 40058, 21314, 38840, 14759, 14771, 81221, 13948, 81563, 81940, 6130, 50431, 50411, 34155, 34158, 43164, 38734, 8668, 77158, 73329, 37361, 52573, 9941, 47524, 15886, 57287, 58988, 51543, 51029, 51524, 17365, 33586, 16968, 19898, 80676, 90568, 61706, 53257, 53160, 72157, 38395, 17949, 73380, 4574, 39825, 38730, 51232, 27986, 71975, 33770, 59340, 50625, 90787, 16828, 40697, 28091, 47591, 31165, 58306, 16908, 52342, 55050, 75995, 52589, 52600, 15529, 27905, 72417, 84840, 84839, 11489, 62727, 76642, 51722, 17410, 17386, 68556, 55832, 16868, 80745, 73348, 73707, 50971, 53669, 15481, 62570, 61159, 14753, 74610, 81142, 81496, 81495, 14385, 72645);
COMMIT;
-- 598 lignes mis à jour.

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Sélection des tronçons s'intersectant en-dehors des start/end points
SELECT
    a.cnumtrc || ',' AS code_troncon_a,
    c.ccomvoi AS id_voie_a,
    d.cnumtrc || ',' AS code_troncon_b,
    f.ccomvoi AS id_voie_b
FROM
    G_BASE_VOIE.TEMP_ILTATRC a
    INNER JOIN G_BASE_VOIE.TEMP_VOIECVT b ON b.cnumtrc = a.cnumtrc
    INNER JOIN G_BASE_VOIE.TEMP_VOIEVOI c ON c.ccomvoi = b.ccomvoi,
    G_BASE_VOIE.TEMP_ILTATRC d
    INNER JOIN G_BASE_VOIE.TEMP_VOIECVT e ON e.cnumtrc = d.cnumtrc
    INNER JOIN G_BASE_VOIE.TEMP_VOIEVOI f ON f.ccomvoi = e.ccomvoi
WHERE 
    a.cnumtrc < d.cnumtrc
    AND SDO_ANYINTERACT(a.ora_geometry, d.ora_geometry) = 'TRUE'
    AND SDO_LRS.CONNECTED_GEOM_SEGMENTS(
            SDO_LRS.CONVERT_TO_LRS_GEOM(a.ora_geometry), 
            SDO_LRS.CONVERT_TO_LRS_GEOM(d.ora_geometry), 
            0.005
        ) = 'FALSE'
    AND b.ccomvoi < e.ccomvoi
    AND a.cdvaltro = 'V'
    AND b.cvalide = 'V'
    AND d.cdvaltro = 'V'
    AND e.cvalide = 'V';
-- Résultat : 415 intersections

-- Mise à jour du champ fid_etat de TEMP_B_TRONCON avec la valeur indiquant que le tronçon croise un autre tronçon en-dehors des start/end points
--Le IN() de la condition se rempli avec le résultat de la requête ci-dessus (compilation des champs code_troncon_a et code_troncon_b en supprimant les doublons)
UPDATE TEMP_B_TRONCON 
SET fid_etat = 5
WHERE
    objectid IN(14338, 14267, 2180, 98, 99, 104, 139, 141, 154, 155, 157, 158, 159, 160, 161, 162, 163, 164, 2427, 235, 302, 354, 402, 437, 528, 632, 633, 790, 797, 975, 1064, 1158, 1234, 16240, 1255, 1269, 1284, 1351, 1369, 58635, 1463, 1590, 1610, 1717, 1720, 1723, 1734, 1737, 1795, 1823, 1824, 1827, 1828, 1834, 1829, 1830, 58668, 1841, 2080, 14743, 14751, 2708, 2757, 3378, 3530, 3649, 10793, 4861, 4552, 15481, 15485, 15361, 15456, 7697, 13953, 9673, 14129, 10388, 10488, 10516, 7797, 8871, 12468, 12328, 14564, 629, 15982, 15989, 15994, 13818, 16586, 16641, 13980, 13981, 17949, 18148, 17984, 18028, 20007, 20020, 17874, 52326, 7904, 22087, 22683, 22890, 24198, 17881, 17362, 16105, 26783, 26958, 28106, 28182, 28242, 29498, 29522, 6593, 11784, 34090, 33639, 33651, 11902, 34136, 11905, 35820, 2809, 2811, 36395, 9472, 36512, 36513, 36546, 36612, 36613, 36617, 36618, 36619, 36716, 36622, 36625, 36627, 36629, 36630, 36633, 36719, 36720, 59049, 9895, 38715, 38728, 38727, 47766, 41872, 41645, 9867, 39092, 39249, 39251, 41706, 39533, 39659, 41651, 41014, 9881, 40155, 40289, 40290, 40343, 40344, 41650, 41025, 41029, 41030, 41033, 41036, 41081, 41083, 41110, 13929, 41236, 41800, 41310, 52490, 41860, 43210, 56156, 16233, 43769, 43656, 43670, 43674, 45344, 7138, 11732, 47300, 47754, 47567, 13924, 9215, 49118, 48354, 48531, 48580, 48582, 49466, 48626, 48796, 48865, 49043, 49054, 49070, 49185, 49186, 49189, 49586, 49214, 49222, 49225, 49533, 49683, 50128, 50531, 50184, 50761, 6266, 56349, 6403, 17223, 53985, 54021, 7898, 54190, 54224, 54232, 54242, 11878, 14969, 14965, 14972, 11819, 58665, 59292, 57393, 59164, 59106, 59108, 3298, 7993, 11998, 16119, 60315, 50987, 16709, 52587, 4570, 4557, 52615, 13755, 4576, 52601, 18553, 52668, 52563, 51548, 18550, 18551, 51189, 16559, 58554, 58549, 64240, 64282, 64300, 64397, 11899, 66124, 66134, 8646, 66811, 66844, 66860, 58386, 67541, 68336, 68337, 68342, 69011, 68669, 11740, 69012, 69509, 12945, 69734, 69737, 69740, 69743, 69738, 70313, 51712, 55535, 54784, 54785, 8928, 8941, 8908, 8917, 7921, 8907, 11966, 73011, 16297, 73765, 73972, 73849, 76662, 8595, 77595, 50652, 78351, 78398, 78796, 56639, 8691, 78901, 13946, 78922, 50619, 50621, 78712, 78729, 78855, 13992, 9582, 82499, 82864, 56887, 17868, 85612, 14342, 14304, 11951, 1488, 2278, 2282, 1552, 852, 1130, 2474, 1012, 1042, 207, 1761, 1764, 1988, 1152, 1985, 15904, 1414, 1267, 1839, 1162, 52416, 12828, 2185, 307, 1591, 1840, 1718, 1740, 2200, 818, 863, 16338, 2012, 2573, 12816, 2335, 2475, 16239, 1485, 2212, 56523, 1957, 1356, 1374, 1416, 1396, 59301, 1474, 1833, 1825, 1726, 1731, 1741, 1806, 58909, 2083, 15883, 14752, 2777, 4065, 17938, 3962, 10832, 54524, 5702, 16836, 15529, 15370, 15460, 90862, 9701, 13970, 13982, 16903, 10561, 10558, 10560, 90052, 14031, 12476, 14567, 15987, 15992, 15998, 16672, 16733, 16747, 18095, 56930, 18164, 20016, 36610, 52327, 22086, 22097, 22891, 22895, 24425, 24424, 25119, 27173, 28347, 29523, 29532, 16513, 31165, 34107, 34128, 34062, 17207, 34144, 34206, 35859, 35818, 13901, 59104, 59107, 36606, 36614, 36624, 36631, 36637, 36638, 59130, 59070, 59074, 64286, 64429, 59071, 40454, 41109, 85983, 66221, 41959, 41653, 41360, 41368, 41026, 52465, 41021, 41710, 41188, 41843, 56348, 41852, 56339, 13930, 41362, 41289, 41868, 41859, 41211, 41203, 41844, 41041, 41365, 41865, 85821, 41278, 85992, 41796, 85804, 43669, 43675, 56158, 43671, 44497, 43715, 43718, 43681, 45531, 13893, 50161, 47533, 52654, 49440, 49190, 49063, 49250, 48792, 49691, 49684, 49067, 48861, 49183, 49254, 49659, 49239, 49676, 49654, 49690, 57231, 50532, 76974, 50809, 50812, 54833, 90590, 13494, 57327, 54236, 54243, 54259, 54262, 54234, 54367, 54235, 54263, 56479, 15804, 14973, 58174, 59086, 59294, 59128, 59213, 59129, 6454, 60314, 60113, 60316, 62835, 62741, 51213, 51214, 61350, 61849, 61925, 62139, 62450, 62370, 62078, 52599, 62305, 62406, 52561, 52590, 52585, 63006, 16560, 58556, 64431, 64430, 64434, 66125, 66142, 13921, 66927, 66866, 66906, 67547, 68968, 68346, 68422, 69022, 68764, 68765, 69015, 69615, 69665, 69742, 69745, 70445, 57720, 73837, 73330, 73592, 73220, 73166, 17404, 73143, 73767, 73973, 73910, 77208, 77222, 77226, 58328, 77600, 78884, 78885, 78853, 78899, 78895, 78905, 78743, 13935, 13941, 78907, 78701, 78931, 78924, 13993, 9584, 9583, 82511, 82871, 56889, 56890, 84163, 85622 );
-- 643 lignes mis à jour.